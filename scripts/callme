#!/bin/bash
# Updated: 2026-01-12 19:10:00
# callme - Make a phone call with a message using Twilio
# Usage: callme "Your message here"

# Load env from Eames config (NOT Claude Code settings)
SETTINGS_FILE="$HOME/.eames/config.json"
if [ -f "$SETTINGS_FILE" ]; then
  export CALLME_USER_PHONE_NUMBER=$(jq -r '.env.CALLME_USER_PHONE_NUMBER // empty' "$SETTINGS_FILE" 2>/dev/null)
  export CALLME_PHONE_ACCOUNT_SID=$(jq -r '.env.CALLME_PHONE_ACCOUNT_SID // empty' "$SETTINGS_FILE" 2>/dev/null)
  export CALLME_PHONE_AUTH_TOKEN=$(jq -r '.env.CALLME_PHONE_AUTH_TOKEN // empty' "$SETTINGS_FILE" 2>/dev/null)
  export CALLME_PHONE_NUMBER=$(jq -r '.env.CALLME_PHONE_NUMBER // empty' "$SETTINGS_FILE" 2>/dev/null)
fi

# Check required vars
if [ -z "$CALLME_USER_PHONE_NUMBER" ] || [ -z "$CALLME_PHONE_ACCOUNT_SID" ] || [ -z "$CALLME_PHONE_AUTH_TOKEN" ] || [ -z "$CALLME_PHONE_NUMBER" ]; then
  echo "Error: Missing required environment variables in ~/.claude/settings.json:"
  echo "  CALLME_USER_PHONE_NUMBER, CALLME_PHONE_ACCOUNT_SID, CALLME_PHONE_AUTH_TOKEN, CALLME_PHONE_NUMBER"
  exit 1
fi

MESSAGE="${1:-Hello from Eames}"

# URL encode the message for TwiML
ENCODED_MESSAGE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$MESSAGE'''))")

# Create TwiML URL (using Twilio's TwiML Bins or echo service)
TWIML="<Response><Say voice=\"alice\">$MESSAGE</Say></Response>"
TWIML_ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$TWIML'''))")

# Make the call using Twilio API
curl -s -X POST "https://api.twilio.com/2010-04-01/Accounts/$CALLME_PHONE_ACCOUNT_SID/Calls.json" \
  -u "$CALLME_PHONE_ACCOUNT_SID:$CALLME_PHONE_AUTH_TOKEN" \
  -d "To=$CALLME_USER_PHONE_NUMBER" \
  -d "From=$CALLME_PHONE_NUMBER" \
  -d "Twiml=$TWIML" \
  > /dev/null 2>&1

if [ $? -eq 0 ]; then
  echo "üìû Calling you with message: $MESSAGE"
else
  echo "‚ùå Failed to initiate call"
  exit 1
fi
